<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Danish General & Kirana Store</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green-100:#e8f8ef; --green-300:#8ed89f; --green-500:#33b64a; --green-600:#2f9e3f;
    --muted:#6b7280; --card-bg:#ffffff; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:#f4f7f5;color:#0f172a}
  .app-wrap{max-width:980px;margin:18px auto;width:100%;padding-bottom:110px;min-height:calc(100vh - 120px)}
  .hidden{display:none}
  .page{padding:18px;animation:fade .28s}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  header.app-header{padding:18px 20px;border-radius:10px;background:linear-gradient(180deg,#f7fff7,#f2fbf2);margin-bottom:14px}
  header .title{font-size:20px;font-weight:800;margin:0}
  header .subtitle{font-size:13px;color:var(--muted);margin-top:6px}
  .btn{padding:10px 14px;background:var(--green-500);color:white;font-weight:600;border:none;border-radius:10px;cursor:pointer}
  .btn-secondary{background:var(--green-600)}
  .btn-danger{background:var(--danger);color:#fff}
  .input{width:100%;padding:10px 12px;margin:8px 0;border:1px solid #e6e7eb;border-radius:10px;background:var(--card-bg)}
  .small-btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:#111;color:#fff}
  .sub{color:var(--muted);font-size:13px;margin-top:6px}
  .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-top:10px}
  .tile{border-radius:14px;padding:16px;min-height:92px;display:flex;flex-direction:column;justify-content:center;box-shadow:0 10px 30px rgba(20,60,20,0.04);cursor:pointer;border:1px solid rgba(47,158,63,0.06);transition:transform .16s ease}
  .tile:hover{transform:translateY(-6px)}
  .tile .cat-name{font-weight:700;margin:0;color:#06210e}
  .tile .cat-sub{font-size:13px;color:rgba(7,20,9,0.65);margin-top:6px}
  .product-card{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:var(--card-bg);box-shadow:0 8px 26px rgba(7,12,8,0.03);border:1px solid rgba(7,12,8,0.03);margin-bottom:12px}
  .product-card img{width:76px;height:76px;border-radius:12px;object-fit:cover}
  .order-card{padding:14px;border-radius:12px;background:var(--card-bg);box-shadow:0 8px 22px rgba(7,12,8,0.03);border:1px solid rgba(7,12,8,0.03);margin-bottom:12px}
  .order-meta{color:var(--muted);font-size:13px;margin-top:4px}
  .progress-wrap{width:100%;max-width:540px;margin-top:12px}
  .progress-bar{width:100%;height:12px;background:#edf7f1;border-radius:999px;overflow:hidden;border:1px solid rgba(47,158,63,0.06)}
  .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--green-300),var(--green-500));transition:width .45s ease}
  .bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;pointer-events:none}
  .nav-inner{width:100%;max-width:980px;pointer-events:auto;padding:10px 14px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.96));box-shadow:0 12px 30px rgba(7,12,8,0.08);border-radius:14px;display:flex;gap:8px;align-items:center;justify-content:space-between}
  .nav-btn{flex:1;padding:10px;border-radius:10px;border:none;background:transparent;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);font-weight:600}
  .nav-btn.active{background:linear-gradient(90deg,var(--green-300),var(--green-500));color:#fff}
  .nav-icon{font-size:18px}
  .profile-icon{width:64px;height:64px;border-radius:999px;background:linear-gradient(180deg,var(--green-300),var(--green-500));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px}
  .admin-panel{padding:12px;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,0.03)}
  .switch-row{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
  <div class="app-wrap">
    <!-- Header -->
    <header class="app-header" id="globalHeader" style="display:none">
      <div class="title" id="globalTitle">DANISH GENERAL & KIRANA STORE</div>
      <div class="subtitle" id="globalSubtitle">Fresh products, fast delivery and simple shopping.</div>
    </header>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page">
      <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <div style="font-weight:800;font-size:26px;margin-bottom:8px">DANISH GENERAL & KIRANA STORE ‚§∑üõí üõçÔ∏è  ‚ûú] Login</div>
          <input id="loginName" class="input" placeholder="Full Name (required)">
          <input id="loginPhone" class="input" placeholder="Phone Number (required)">
          <input id="loginPassword" class="input" type="password" placeholder="Password (required)">
          <p class="sub" style="margin-top:6px"><strong>Disclaimer:</strong> To view past orders on this device, log in with the same phone number and password every time.</p>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" onclick="login()">Login</button>
            <button class="btn-secondary" onclick="loginAsGuest()">Continue as Guest</button>
          </div>
          <div style="margin-top:18px;padding:14px;border-radius:12px;background:#e8f8ef;border:1px solid rgba(47,158,63,0.15);font-size:14px">
    <div style="font-weight:700;color:#2f9e3f;margin-bottom:6px">üìû Need Help? Contact Us</div>
    <div style="margin-bottom:6px"><strong>üìç Danish General & Kirana Store</strong><br>Saraiya, Madarsa Chowk</div>
    <div style="margin-bottom:8px"> üìû +91-88776 34457</a><br> üìû +91-80846 84412</a></div>
    üí¨ Chat on WhatsApp</a>
  </div>
        </div>
        <div style="min-width:110px;text-align:center">
          <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" width="100" alt="logo">
        </div>
      </div>
    </div>

    <!-- HOME / DASHBOARD (Categories) -->
    <div id="homePage" class="page hidden">
      <div style="margin-top:6px">
        <h3 style="margin:0 0 6px 0;font-size:18px;font-weight:700">Categories</h3>
        <div id="categoriesList" class="categories-grid"></div>
        <!-- contact box insertion point (optional) -->
        <div id="homeContactBox"></div>
      </div>
    </div>

    <!-- ORDERS PAGE -->
    <div id="ordersPage" class="page hidden">
      <h3 style="margin:0 0 6px 0;font-size:18px;font-weight:700">My Orders</h3>
      <div id="userOrdersList"></div>
    </div>

    <!-- ACCOUNT PAGE -->
    <div id="accountPage" class="page hidden">
      <h3 style="margin:0 0 6px 0;font-size:18px;font-weight:700">My Account</h3>
      <div class="account-card">
        <div class="account-row" style="align-items:center">
          <div class="profile-icon" id="profileInitial">G</div>
          <div style="flex:1">
            <div style="font-weight:700" id="accountNameDisplay">Guest</div>
            <div class="sub" id="accountPhoneDisplay">Not logged in</div>
            <div class="sub" id="accountSinceDisplay" style="margin-top:8px">Member since ‚Äî</div>
          </div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)">
        <div>
          <label style="font-weight:600;font-size:14px">Full Name</label>
          <input id="accountNameInput" class="input" placeholder="Your name">
          <label style="font-weight:600;font-size:14px">Phone</label>
          <input id="accountPhoneInput" class="input" readonly>
          <label style="font-weight:600;font-size:14px">Address</label>
          <textarea id="accountAddressInput" class="input" rows="3" placeholder="Delivery address (optional)"></textarea>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn" onclick="saveProfileFromAccount()">Save Profile</button>
            <button class="btn-danger" onclick="logout()">Logout</button>
          </div>

          <!-- Admin button -->
          <div id="adminAccessBox" style="margin-top:12px;display:none">
            <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)">
            <div class="sub" style="margin-bottom:8px">Admin Controls</div>
            <button class="btn-secondary" onclick="openAdminPanel()">Open Admin Panel</button>
          </div>
        </div>
      </div>

      <!-- contact box insertion point in account -->
      <div id="accountContactBox"></div>
    </div>

    <!-- PRODUCTS PAGE -->
    <div id="productsPage" class="page hidden">
      <button class="small-btn" onclick="showPage('home')">‚Üê Back</button>
      <h3 id="productCategoryTitle" style="margin:12px 0 6px 0;font-size:18px;font-weight:700"></h3>
      <div id="productsList"></div>
    </div>

    <!-- PAYMENT PAGE -->
    <div id="paymentPage" class="page hidden">
      <button class="small-btn" onclick="showPage('home')">‚Üê Cancel</button>
      <h3 style="margin:12px 0 6px 0;font-size:18px;font-weight:700">Payment</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn" onclick="choosePayment('COD')">Cash On Delivery</button>
        <button class="btn-secondary" onclick="choosePayment('UPI')">UPI</button>
      </div>

      <div id="upiBox" class="hidden" style="border-radius:10px;padding:12px;background:#f6fff6;border:1px solid rgba(47,158,63,0.08);margin-bottom:12px">
        <div style="font-weight:700;color:var(--green-600)">UPI Payment</div>
        <div style="margin-top:6px;color:var(--muted)">UPI ID: <strong style="display:inline-block;margin-left:8px">8877634457</strong></div>
      </div>

      <div id="userDetails" class="hidden" style="max-width:720px">
        <input id="orderName" class="input" placeholder="Full Name (required)">
        <input id="orderPhone" class="input" placeholder="Phone Number (required)">
        <textarea id="orderAddress" class="input" placeholder="Address (required)" rows="3"></textarea>
        <div style="display:flex;gap:10px;margin-top:8px">
          <button class="btn" onclick="confirmOrder()">Confirm Order</button>
          <button class="btn-danger" onclick="showPage('home')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="page hidden">
      <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:700">Admin Panel</h3>
      <div style="display:grid;grid-template-columns:1fr 380px;gap:16px">
        <!-- Left: Orders -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:600">All Orders</div>
            <div class="switch-row">
              <label style="font-size:13px;color:var(--muted);margin-right:6px">Notifications</label>
              <input id="notifyToggle" type="checkbox" />
            </div>
          </div>
          <div id="adminOrdersList"></div>
        </div>

        <!-- Right: Add Product -->
        <div class="admin-panel">
          <div style="font-weight:700;margin-bottom:8px">Add Product</div>
          <input id="adminProductName" class="input" placeholder="Product name">
          <input id="adminProductPrice" class="input" placeholder="Price">
          <select id="adminProductCategory" class="input"></select>
          <input id="adminProductImage" type="file" accept="image/*" class="input">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" onclick="adminAddProduct()">Add Product</button>
            <button class="btn-secondary" onclick="loadAdminPanel()">Refresh</button>
          </div>
          <div class="sub" style="margin-top:10px">Images are saved as Base64 in localStorage (demo).</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav" id="bottomNav" style="display:none">
    <div class="nav-inner">
      <button class="nav-btn" id="navHome" onclick="navClick('home')">
        <div class="nav-icon">üè†</div><div style="font-size:13px">Home</div>
      </button>
      <button class="nav-btn" id="navOrders" onclick="navClick('orders')">
        <div class="nav-icon">üì¶</div><div style="font-size:13px">Orders</div>
      </button>
      <button class="nav-btn" id="navAccount" onclick="navClick('account')">
        <div class="nav-icon">üë§</div><div style="font-size:13px">Account</div>
      </button>
    </div>
  </div>

<script>
/* ================== CONFIG: encoded bot & chat (semi-secure) ================== */
/* Replace these base64 values if you want to change bot/chat later */
const _ENC_BOT = "ODQ3MjMzNjI2NzpBQUVCSFZpcHhmdHQwWHpHZDJuanprclJ6bFZlOUJnUms1SQ=="; // base64 of token
const _ENC_CHAT = "NjYxNzIwMzg1NQ=="; // base64 of chat id
function decodeEnc(v){ try{ return decodeURIComponent(escape(window.atob(v))); } catch(e){ return window.atob(v); } }
const TELEGRAM_BOT_TOKEN = decodeEnc(_ENC_BOT);
const TELEGRAM_CHAT_ID = decodeEnc(_ENC_CHAT);

/* ================== STORAGE KEYS & initial DB ================== */
const DB_KEY = 'groceryDB_demo_v1';
const PROFILE_KEY = 'groceryProfiles_demo_v1';
let db = {
  categories:["Grocery","Cold Drinks","Oil & Ghee","Stationary","Chips","Biscuits","Chocolates","Toffee","Tobacco"],
  products:[
    {name:"Rice 1kg",price:"60",category:"Grocery",image:null},
    {name:"Atta 1kg",price:"45",category:"Grocery",image:null},
    {name:"Coke 1L",price:"45",category:"Cold Drinks",image:null}
  ],
  orders:[]
};
if(localStorage.getItem(DB_KEY)){ try{ db = JSON.parse(localStorage.getItem(DB_KEY)); } catch(e){ console.warn("DB parse err", e); } }
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

/* ================== Profiles ================== */
function loadProfiles(){ const raw = localStorage.getItem(PROFILE_KEY); return raw ? JSON.parse(raw) : {}; }
function saveProfiles(obj){ localStorage.setItem(PROFILE_KEY, JSON.stringify(obj)); }
function userKey(phone, pass){ return `${phone}_${pass}`; }

/* ================== state ================== */
let loggedUser = null;
let isAdmin = false;
let selectedProduct = null, selectedPrice = null, paymentMethod = null;

/* ================== UI helpers ================== */
function showHeader(show, title, subtitle){
  const header = document.getElementById('globalHeader');
  const gTitle = document.getElementById('globalTitle');
  const gSub = document.getElementById('globalSubtitle');
  if(!show){ header.style.display='none'; return; }
  header.style.display='block';
  gTitle.innerText = title || '';
  gSub.innerText = subtitle || '';
}
function hideAllPages(){ document.querySelectorAll('#loginPage,#homePage,#ordersPage,#accountPage,#productsPage,#paymentPage,#adminPanel').forEach(el=>el.classList.add('hidden')); }
function showPage(page){
  hideAllPages();
  if(page === 'home'){
    showHeader(true, 'DANISH GENERAL & KIRANA STORE üõíüõçÔ∏è', 'Your neighbourhood Kirana store with everything you need. üöö Your kirana delivered to your doorstep.Shop from home, we‚Äôll handle the rest.No waiting, no hassle, just convenience.Fast delivery. Fresh products. Every time.');
    document.getElementById('homePage').classList.remove('hidden');
    loadCategories();
    highlightNav('home');
  } else if(page === 'orders'){
    showHeader(true, 'My Orders', '');
    document.getElementById('ordersPage').classList.remove('hidden');
    renderUserOrders();
    highlightNav('orders');
  } else if(page === 'account'){
    showHeader(true, 'My Account', '');
    document.getElementById('accountPage').classList.remove('hidden');
    populateAccountInputs();
    highlightNav('account');
  } else if(page === 'products'){
    showHeader(false);
    document.getElementById('productsPage').classList.remove('hidden');
    highlightNav('home');
  } else if(page === 'payment'){
    showHeader(false);
    document.getElementById('paymentPage').classList.remove('hidden');
    highlightNav('home');
  } else if(page === 'admin'){
    showHeader(true, 'Admin - Manage Store', '');
    document.getElementById('adminPanel').classList.remove('hidden');
    loadAdminPanel();
    highlightNav('home');
  }
}
function showBottomNav(show){ document.getElementById('bottomNav').style.display = show ? 'block' : 'none'; }
function highlightNav(key){ ['navHome','navOrders','navAccount'].forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.remove('active'); }); if(key==='home') document.getElementById('navHome').classList.add('active'); if(key==='orders') document.getElementById('navOrders').classList.add('active'); if(key==='account') document.getElementById('navAccount').classList.add('active'); }

/* ================== Auth ================== */
function login(){
  const name = document.getElementById('loginName').value.trim();
  const phone = document.getElementById('loginPhone').value.trim();
  const pass = document.getElementById('loginPassword').value;
  if(!name || !phone || !pass) return alert('Enter name, phone and password.');
  const key = userKey(phone, pass);
  loggedUser = key;
  // CORRECT admin check (fixed)
  isAdmin = (phone === '999985850' && pass === '@danish');
  const profiles = loadProfiles();
  if(!profiles[key]) profiles[key] = { name, phone, address:'', createdAt:new Date().toISOString() };
  else profiles[key].name = name;
  saveProfiles(profiles);
  document.getElementById('loginPage').classList.add('hidden');
  showBottomNav(true);
  showPage('home');
  populateAccountInputs();
  toggleAdminAccessUI();
}
function loginAsGuest(){
  loggedUser = 'guest_guest';
  isAdmin = false;
  document.getElementById('loginPage').classList.add('hidden');
  showBottomNav(true);
  showPage('home');
  populateAccountInputs();
  toggleAdminAccessUI();
}
function logout(){
  loggedUser = null; isAdmin = false;
  document.getElementById('loginName').value=''; document.getElementById('loginPhone').value=''; document.getElementById('loginPassword').value='';
  hideAllPages(); showHeader(false); showBottomNav(false);
  document.getElementById('loginPage').classList.remove('hidden');
  toggleAdminAccessUI();
}

/* ================== Account ================== */
function populateAccountInputs(){
  const profiles = loadProfiles();
  const profile = loggedUser && profiles[loggedUser] ? profiles[loggedUser] : null;
  document.getElementById('profileInitial').innerText = profile ? (profile.name ? profile.name.slice(0,2).toUpperCase() : 'U') : 'G';
  document.getElementById('accountNameDisplay').innerText = profile ? (profile.name || 'User') : 'Guest';
  document.getElementById('accountPhoneDisplay').innerText = profile ? (`+91 ${profile.phone}`) : 'Not logged in';
  document.getElementById('accountSinceDisplay').innerText = profile && profile.createdAt ? new Date(profile.createdAt).toLocaleDateString() : '‚Äî';
  document.getElementById('accountNameInput').value = profile ? (profile.name || '') : '';
  document.getElementById('accountPhoneInput').value = profile ? (profile.phone || '') : (loggedUser ? loggedUser.split('_')[0] : '');
  document.getElementById('accountAddressInput').value = profile ? (profile.address || '') : '';
}
function saveProfileFromAccount(){
  if(!loggedUser || loggedUser === 'guest_guest') return alert('Please login to save profile.');
  const profiles = loadProfiles();
  const p = profiles[loggedUser] || {};
  const newName = document.getElementById('accountNameInput').value.trim();
  const newAddr = document.getElementById('accountAddressInput').value.trim();
  if(!newName) return alert('Name cannot be empty.');
  p.name = newName;
  p.address = newAddr;
  p.phone = document.getElementById('accountPhoneInput').value.trim();
  if(!p.createdAt) p.createdAt = new Date().toISOString();
  profiles[loggedUser] = p;
  saveProfiles(profiles);
  populateAccountInputs();
  alert('Profile saved.');
}
function toggleAdminAccessUI(){
  const box = document.getElementById('adminAccessBox');
  if(isAdmin) box.style.display = 'block'; else box.style.display = 'none';
}

/* ================== Categories / Products ================== */
const categoryTints = {
  "Grocery":"linear-gradient(135deg,#e8f7ed,#d4f3de)",
  "Cold Drinks":"linear-gradient(135deg,#e8f7fb,#d9f3f9)",
  "Oil & Ghee":"linear-gradient(135deg,#fff9ec,#fff3d8)",
  "Stationary":"linear-gradient(135deg,#eefaf3,#eaf9f0)",
  "Chips":"linear-gradient(135deg,#fff9f2,#fff6ee)",
  "Biscuits":"linear-gradient(135deg,#fffaf0,#fff7ea)",
  "Chocolates":"linear-gradient(135deg,#fff7fb,#fff3f7)",
  "Toffee":"linear-gradient(135deg,#fffaf6,#fff7f0)",
  "Tobacco":"linear-gradient(135deg,#f7fbf7,#f2faf2)"
};
function loadCategories(){
  const container = document.getElementById('categoriesList');
  let html = '';
  db.categories.forEach(cat=>{
    const tint = categoryTints[cat] || '#fff';
    html += `<div class="tile" style="background:${tint}" onclick="openCategory('${escapeHtml(cat)}')">
      <div class="cat-name">${cat}</div>
      <div class="cat-sub">Explore ${cat}</div>
    </div>`;
  });
  container.innerHTML = html;
  // optionally inject contact box on home
  const contactHTML = `<div style="margin-top:18px;padding:14px;border-radius:12px;background:#e8f8ef;border:1px solid rgba(47,158,63,0.15);font-size:14px">
    <div style="font-weight:700;color:#2f9e3f;margin-bottom:6px">üìû Need Help? Contact Us</div>
    <div style="margin-bottom:6px"><strong>üìç Danish General & Kirana Store</strong><br>Saraiya, Madarsa Chowk</div>
    <div style="margin-bottom:8px"> üìû +91-88776 34457</a><br> üìû +91-80846 84412</a></div>
    üí¨ Chat on WhatsApp</a>
  </div>`;
  document.getElementById('homeContactBox').innerHTML = contactHTML;
}

/* open category */
function openCategory(cat){
  selectedCategory = cat;
  document.getElementById('productCategoryTitle').innerText = cat;
  populateProducts(cat);
  showPage('products');
}
function populateProducts(cat){
  const container = document.getElementById('productsList');
  const list = db.products.filter(p=>p.category===cat);
  if(list.length===0){ container.innerHTML = "<p class='sub'>No products in this category.</p>"; return; }
  let html = '';
  list.forEach(p=>{
    html += `<div class="product-card">
      <img src="${p.image || 'https://via.placeholder.com/160'}" alt="">
      <div style="flex:1"><div style="font-weight:700">${p.name}</div><div class="sub" style="margin-top:6px">Category: ${p.category}</div></div>
      <div style="text-align:right"><div style="font-weight:700;margin-bottom:10px">‚Çπ${p.price}</div><div><button class="btn" onclick="startPurchase('${escapeHtml(p.name)}','${p.price}')">Buy</button></div></div>
    </div>`;
  });
  container.innerHTML = html;
}

/* ================== Checkout & Orders ================== */
function startPurchase(name, price){
  selectedProduct = unescapeHtml(name);
  selectedPrice = price;
  const profiles = loadProfiles();
  if(loggedUser && profiles[loggedUser]){
    const p = profiles[loggedUser];
    document.getElementById('orderName').value = p.name || '';
    document.getElementById('orderPhone').value = p.phone || '';
    document.getElementById('orderAddress').value = p.address || '';
  } else {
    document.getElementById('orderName').value = '';
    document.getElementById('orderPhone').value = loggedUser && loggedUser !== 'guest_guest' ? loggedUser.split('_')[0] : '';
    document.getElementById('orderAddress').value = '';
  }
  paymentMethod = null;
  document.getElementById('upiBox').classList.add('hidden');
  document.getElementById('userDetails').classList.add('hidden');
  showPage('payment');
}
function choosePayment(method){
  paymentMethod = method;
  if(method === 'UPI') document.getElementById('upiBox').classList.remove('hidden');
  document.getElementById('userDetails').classList.remove('hidden');
}

/* ================== Telegram notification functions ================== */
/* send a nicely formatted "Style B" telegram message.
   Only sends if admin toggle is ON (stored in localStorage 'notifyEnabled') */
function notifyEnabled(){
  return localStorage.getItem('notifyEnabled') === 'true';
}
async function sendTelegramNotification(order){
  try {
    const token = TELEGRAM_BOT_TOKEN;
    const chatId = TELEGRAM_CHAT_ID;

    const message =
`üì¶ *New Order Received*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ *Customer:* ${order.name}
üìû *Phone:* ${order.phone}
üè† *Address:* ${order.address}

üõç *Product:* ${order.product}
üí∞ *Price:* ‚Çπ${order.price}
üí≥ *Method:* ${order.method}

‚è∞ *Time:* ${new Date(order.createdAt).toLocaleString()}`;

    await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
        parse_mode: "Markdown"
      })
    });

  } catch (err) {
    console.warn("Telegram Error:", err);
  }
}

/* ================== confirmOrder (places order) ================== */
function confirmOrder(){
  const name = document.getElementById('orderName').value.trim();
  const phone = document.getElementById('orderPhone').value.trim();
  const address = document.getElementById('orderAddress').value.trim();
  if(!name || !phone || !address) return alert('Please fill Name, Phone and Address.');
  if(!paymentMethod) return alert('Choose a payment method.');

  const user = loggedUser || 'guest_guest';
  const order = {
    user, name, product: selectedProduct, price: selectedPrice, method: paymentMethod, phone, address,
    status: (paymentMethod==='COD'?'Ordered':'Pending Payment'), createdAt: new Date().toISOString()
  };

  db.orders.push(order);
  saveDB();

  // save into profile if logged in
  if(loggedUser && loggedUser !== 'guest_guest'){
    const profiles = loadProfiles();
    profiles[loggedUser] = profiles[loggedUser] || { name, phone, address, createdAt: new Date().toISOString() };
    profiles[loggedUser].address = address;
    profiles[loggedUser].name = name;
    profiles[loggedUser].phone = phone;
    saveProfiles(profiles);
  }

  // Telegram notify (if enabled)
  sendTelegramNotification(order);

  alert('Order placed.');
  showPage('orders');
  renderUserOrders();
}

/* ================== render user orders ================== */
function renderUserOrders(){
  const container = document.getElementById('userOrdersList');
  const key = loggedUser || 'guest_guest';
  const orders = db.orders.filter(o => o.user === key);
  if(orders.length===0){ container.innerHTML = "<p class='sub'>No orders found for this account.</p>"; return; }
  let html = '';
  orders.slice().reverse().forEach(o=>{
    const pct = getProgressPercent(o.status);
    html += `<div class="order-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:700">${escapeHtml(o.product)} ‚Ä¢ ‚Çπ${escapeHtml(o.price)}</div>
          <div class="order-meta">${escapeHtml(o.name)} ‚Ä¢ ${escapeHtml(o.phone)} ‚Ä¢ ${formatDate(o.createdAt)}</div>
          <div style="color:var(--muted);margin-top:8px">${escapeHtml(o.address)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${escapeHtml(o.status)}</div>
        </div>
      </div>
      <div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div class="progress-label">Stage: ${escapeHtml(o.status)}</div></div>
    </div>`;
  });
  container.innerHTML = html;
}

/* ================== Admin panel: load, update, delete, add product ================== */
function openAdminPanel(){
  if(!isAdmin) return alert('Admin access only.');
  showPage('admin');
  loadAdminPanel();
}
function loadAdminPanel(){
  // populate category select
  const select = document.getElementById('adminProductCategory');
  select.innerHTML = '';
  db.categories.forEach(c => select.innerHTML += `<option value="${escapeHtml(c)}">${c}</option>`);

  // load notification toggle state
  const toggle = document.getElementById('notifyToggle');
  toggle.checked = localStorage.getItem('notifyEnabled') === 'true';
  toggle.onchange = function(){ localStorage.setItem('notifyEnabled', toggle.checked ? 'true' : 'false'); alert('Notifications ' + (toggle.checked ? 'enabled' : 'disabled') + '.'); };

  // render orders (reverse chronological)
  const container = document.getElementById('adminOrdersList');
  if(!db.orders.length){
    container.innerHTML = "<p class='sub'>No orders.</p>";
    return;
  }
  let oHtml = '';
  db.orders.slice().reverse().forEach(o=>{
    const idx = db.orders.findIndex(x=>x.createdAt===o.createdAt && x.product===o.product && x.phone===o.phone && x.name===o.name);
    oHtml += `<div class="order-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:700">${escapeHtml(o.product)} ‚Äî ‚Çπ${escapeHtml(o.price)}</div>
          <div class="order-meta">${escapeHtml(o.name)} ‚Ä¢ ${escapeHtml(o.phone)} ‚Ä¢ ${formatDate(o.createdAt)}</div>
          <div style="color:var(--muted);margin-top:8px">${escapeHtml(o.address)}</div>
        </div>
        <div style="text-align:right;min-width:220px">
          <div style="margin-bottom:6px">Current: <strong id="adminStatusLabel_${idx}">${escapeHtml(o.status)}</strong></div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <select id="statusSelect_${idx}" class="input">
              ${['Pending Payment','Ordered','Packed','Out for Delivery','Delivered','Cancelled'].map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}
            </select>
            <button class="btn" onclick="updateOrderStatus(${idx})">Update</button>
            <button class="small-btn" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--danger')||'#ef4444'};color:#fff" onclick="adminDeleteOrder(${idx})">Delete</button>
          </div>
        </div>
      </div>
      <div class="progress-wrap" style="margin-top:12px">
        <div class="progress-bar"><div class="progress-fill" style="width:${getProgressPercent(o.status)}%"></div></div>
        <div class="progress-label">Stage: ${escapeHtml(o.status)}</div>
      </div>
    </div>`;
  });
  container.innerHTML = oHtml;
}
function updateOrderStatus(i){
  const sel = document.getElementById(`statusSelect_${i}`);
  if(!sel) return;
  const old = db.orders[i].status;
  db.orders[i].status = sel.value;
  saveDB();
  loadAdminPanel();
  alert('Status updated.');
  // notify admin (if enabled)
  sendTelegramNotification(db.orders[i], `Status changed: ${old} ‚Üí ${db.orders[i].status}`);
}
function adminDeleteOrder(i){
  if(!confirm('Delete this order?')) return;
  const o = db.orders[i];
  sendTelegramNotification(Object.assign({}, o, { product: o.product + " (deleted)" }), "Order deleted by admin.");
  db.orders.splice(i,1);
  saveDB();
  loadAdminPanel();
  alert('Order deleted.');
}

/* Admin add product with Base64 image saving */
function adminAddProduct(){
  const name = document.getElementById('adminProductName').value.trim();
  const price = document.getElementById('adminProductPrice').value.trim();
  const category = document.getElementById('adminProductCategory').value;
  const file = document.getElementById('adminProductImage').files[0];
  if(!name || !price || !category) return alert('Fill product name, price and choose category.');
  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      db.products.push({ name, price, category, image: e.target.result });
      saveDB(); loadAdminPanel(); alert('Product added.');
      document.getElementById('adminProductName').value=''; document.getElementById('adminProductPrice').value=''; document.getElementById('adminProductImage').value='';
    };
    reader.readAsDataURL(file);
  } else {
    db.products.push({ name, price, category, image: null });
    saveDB(); loadAdminPanel(); alert('Product added (no image).');
    document.getElementById('adminProductName').value=''; document.getElementById('adminProductPrice').value='';
  }
}

/* ================== Utilities ================== */
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function unescapeHtml(str){ return String(str||'').replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"); }
function formatDate(iso){ return iso ? new Date(iso).toLocaleString() : ''; }
function getProgressPercent(status){
  const stages = ["Ordered","Packed","Out for Delivery","Delivered"];
  if(status==='Pending Payment' || status==='Cancelled') return 0;
  const idx = stages.indexOf(status);
  if(idx<0) return 0;
  return Math.round(((idx+1)/stages.length)*100);
}

/* ================== Navigation helpers ================== */
function navClick(target){
  if(!loggedUser){ alert('Please login first.'); return; }
  if(target==='home') showPage('home');
  if(target==='orders') showPage('orders');
  if(target==='account') showPage('account');
}

/* ================== Init ================== */
document.addEventListener('DOMContentLoaded', function(){
  db.categories = db.categories||[];
  db.products = db.products||[];
  db.orders = db.orders||[];
  document.getElementById('loginPage').classList.remove('hidden');
  showHeader(false);
  showBottomNav(false);
  // inject contact block into account
  const contactHTML = `<div style="margin-top:18px;padding:14px;border-radius:12px;background:#e8f8ef;border:1px solid rgba(47,158,63,0.15);font-size:14px">
    <div style="font-weight:700;color:#2f9e3f;margin-bottom:6px">üìû Need Help? Contact Us</div>
    <div style="margin-bottom:6px"><strong>üìç Danish General & Kirana Store</strong><br>Saraiya, Madarsa Chowk</div>
    <div style="margin-bottom:8px"> üìû +91-88776 34457</a><br> üìû +91-80846-84412</a></div>
    üí¨ Chat on WhatsApp</a>
  </div>`;
  document.getElementById('accountContactBox').innerHTML = contactHTML;
});

/* ================== End script ================== */
</script>
</body>
</html>
